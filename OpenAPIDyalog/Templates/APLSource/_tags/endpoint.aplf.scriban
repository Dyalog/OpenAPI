response←{{ operation_id }} argsNs;headerParams;queryParams;body;clientArgs;secSchemes
⍝ {{ method | string.upcase }} {{ path }}
{{~ if summary ~}}
⍝ {{ summary }}
{{~ end ~}}
{{~ if description ~}}
{{ comment_lines description }}
{{~ end ~}}
{{~ if parameters.size > 0 ~}}
⍝
⍝ Parameters:
{{~ for param in parameters ~}}
⍝   - {{ param.name }} (in: {{ param.in | string.downcase }}) [{{ if param.required }}required{{ else }}optional{{ end }}]{{ if param.schema.type }}: {{ param.schema.type }}{{ end }}
{{~ end ~}}
{{~ end ~}}
{{~ if request_json_body_type ~}}
⍝
⍝ Request Body:
⍝   - {{ request_content_type }}: {{ request_json_body_type }} schema{{ if request_body.required }} (required){{ end }}
{{~ end ~}}
{{~ if request_content_type == "application/octet-stream" ~}}
⍝
⍝ Request Body:
⍝   - application/octet-stream: Binary data{{ if request_body.required }} (required){{ end }}
{{~ end ~}}
{{~ if request_content_type == "multipart/form-data" ~}}
⍝
⍝ Request Body:
⍝   - multipart/form-data{{ if request_body.required }} (required){{ end }}
{{~ if form_fields.size > 0 ~}}
⍝     Form fields:
{{~ for field in form_fields ~}}
⍝       - {{ field.dyalog_name }} ({{ field.type }}){{ if field.is_required }} [required]{{ end }}{{ if field.description }} - {{ field.description }}{{ end }}
{{~ end ~}}
{{~ end ~}}
{{~ end ~}}
{{~ if request_content_type && request_content_type != "application/json" && request_content_type != "application/octet-stream" && request_content_type != "multipart/form-data" ~}}
⍝
⍝ Request Body:
⍝   - {{ request_content_type }}: Generic data{{ if request_body.required }} (required){{ end }}
{{~ end ~}}
{{~ if responses.size > 0 ~}}
⍝
⍝ Returns:
{{~ for response_item in responses ~}}
⍝   - {{ response_item.key }}: {{ response_item.value.description }}
{{~ end ~}}
{{~ end ~}}
headerParams←⍬
queryParams←()
body←()

{{~ for param in parameters ~}}
{{~ if param.in == "Query" ~}}
⍝ Query parameter: {{ param.name }}
:If (2=argsNs.⎕NC'{{ param.name }}')
    queryParams.{{ param.name }}←argsNs.{{ param.name }}
:{{ if param.required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: {{ param.name }}')
:{{ end }}EndIf
{{~ end ~}}
{{~ if param.in == "Header" ~}}
⍝ Header parameter: {{ param.name }}
:If (2=argsNs.⎕NC'{{ param.name }}')
    headerParams,←'{{ param.name }}' argsNs.{{ param.name }}
:{{ if param.required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: {{ param.name }}')
:{{ end }}EndIf
{{~ end ~}}
{{~ if param.in == "Path" ~}}
⍝ Path parameter: {{ param.name }}
:If 2≠argsNs.⎕NC'{{ param.name }}'
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: {{ param.name }}')
:EndIf
:If ~c.∆.utils.isValidPathParam argsNs.{{ param.name }}
    ⎕SIGNAL⊂('EN' 11)('Message' 'Invalid parameter: {{ param.name }} (must be a character vector or scalar number)')
:EndIf
:If 2|⎕DR argsNs.{{ param.name }} ⍝ If numeric, convert to string
    argsNs.{{ param.name }}←⍕argsNs.{{ param.name }}
:EndIf
{{~ end ~}}
{{~ end ~}}

{{~ if request_content_type == "application/json" && request_json_body_type ~}}
{{~ # Convert PascalCase to camelCase for parameter name ~}}
{{~ first_char = request_json_body_type | string.slice 0 1 | string.downcase ~}}
{{~ rest_chars = request_json_body_type | string.slice 1 ~}}
{{~ request_body_param_name = first_char + rest_chars ~}}
⍝ Request body (JSON)
:If (0≠argsNs.⎕NC'{{ request_body_param_name }}')
    body←argsNs.{{ request_body_param_name }}
:{{ if request_body.required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: {{ request_body_param_name }}')
:{{ end }}EndIf
{{~ end ~}}
{{~ if request_content_type == "application/octet-stream" ~}}
⍝ Request body (octet-stream)
:If (0≠argsNs.⎕NC'body')
    body←argsNs.body
:{{ if request_body.required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: body')
:{{ end }}EndIf
{{~ end ~}}
{{~ if request_content_type == "multipart/form-data" ~}}
⍝ Request body (multipart/form-data)
{{~ for field in form_fields ~}}
{{~ if field.is_binary ~}}
⍝ Binary field: {{ field.api_name }}{{ if field.description }} - {{ field.description }}{{ end }}
{{~ else ~}}
⍝ Form field: {{ field.api_name }}{{ if field.description }} - {{ field.description }}{{ end }}
{{~ end ~}}
:If (0≠argsNs.⎕NC'{{ field.dyalog_name }}')
    body.{{ field.api_name }}←argsNs.{{ field.dyalog_name }}
:{{ if field.is_required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required form field: {{ field.dyalog_name }}')
:{{ end }}EndIf
{{~ end ~}}
{{~ end ~}}
{{~ if request_content_type && request_content_type != "application/json" && request_content_type != "application/octet-stream" && request_content_type != "multipart/form-data" ~}}
⍝ Request body ({{ request_content_type }})
:If (0≠argsNs.⎕NC'data')
    body←argsNs.data
:{{ if request_body.required }}Else
    ⎕SIGNAL⊂('EN' 11)('Message' 'Missing required parameter: data')
:{{ end }}EndIf
{{~ end ~}}

⍝ Build clientArgs
clientArgs←( ⍝ Basically HttpCommand args in a nutshell
    Command: '{{ method }}'
    URL: ({{ dyalog_path }} ⋄ ())
    Headers: headerParams
{{~ if request_body ~}}
    Params: body
    ContentType: '{{ request_content_type ?? "application/json" }}'
{{~ end ~}}
)

{{~ if has_security ~}}
secSchemes←⍬
{{~ for scheme in security_scheme_names ~}}
secSchemes,←⊂'{{ scheme }}'
{{~ end ~}}
⍝ Auth fn
clientArgs←clientArgs c.∆.utils.Authenticate secSchemes
{{~ end ~}}

queryParams←queryParams ⎕NS 2⊃clientArgs.URL
clientArgs.URL←⊃clientArgs.URL
:If 0≠⍴queryParams.⎕NL-⍳9
    clientArgs.URL,←'?',c.∆.HttpCommand.UrlEncode (queryParams)
:EndIf

⍝ Run and handle response
response←c.∆.utils.request clientArgs